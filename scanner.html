<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner QR - DEBUG MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        #reader { width: 100%; max-width: 500px; margin: 0 auto; }
        .escaneando { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        #debugPanel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center justify-center p-4 text-white">
    
<!-- Panel de Debug -->
<div id="debugPanel">
    <h3 class="font-bold mb-2">🔧 DEBUG MODE</h3>
    <div id="debugLog"></div>
    <button onclick="clearDebugLog()" class="mt-2 text-xs bg-red-500 px-2 py-1 rounded">Limpiar Log</button>
    <button onclick="testConnection()" class="mt-2 text-xs bg-blue-500 px-2 py-1 rounded">Test API</button>
</div>

<div class="text-center mb-8">
    <h1 class="text-3xl font-black text-blue-400 italic">QR GATE SKOOL</h1>
    <p class="text-slate-400 mt-2">Escanea la credencial para registrar acceso</p>
</div>

<div id="reader" class="rounded-2xl overflow-hidden shadow-2xl border-4 border-blue-500 escaneando"></div>

<div id="resultado" class="mt-8 text-center max-w-md mx-auto hidden">
    <div id="mensaje" class="text-xl font-bold mb-4"></div>
    <button onclick="reiniciarEscaneo()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-black py-3 px-6 rounded-2xl transition">ESCANEAR OTRO</button>
</div>

<a href="index.html" class="absolute top-4 left-4 bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full">←</a>

<script>
// ========== CONFIGURACIÓN ==========
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbymZkiBvIebJJ8qIhW9J5YpEL_kVWqJo3UwaLbqQdav-xXMHbH2ahWqaLg3xtw2PF7P/exec";
let html5QrCode = null;

// ========== DEBUG FUNCTIONS ==========
function debugLog(message, type = 'info') {
    const logDiv = document.getElementById('debugLog');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? 'text-red-400' : 
                  type === 'success' ? 'text-green-400' : 
                  'text-yellow-400';
    
    const logEntry = `<div class="mb-1 ${color}">[${timestamp}] ${message}</div>`;
    logDiv.innerHTML = logEntry + logDiv.innerHTML;
    
    // También a consola
    console.log(`[DEBUG] ${message}`);
}

function clearDebugLog() {
    document.getElementById('debugLog').innerHTML = '';
}

async function testConnection() {
    debugLog('🔍 Probando conexión API...');
    
    try {
        // Test 1: Conexión básica
        debugLog('Test 1: Conexión básica...');
        const res1 = await fetch(SCRIPT_URL, {
            method: 'GET',
            mode: 'cors'
        });
        const data1 = await res1.json();
        debugLog(`✓ API responde: ${data1.status} - ${data1.message}`, 'success');
        
        // Test 2: Scan con email de prueba
        debugLog('Test 2: Scan con email prueba...');
        const testEmail = 'ramonv@gmail.com';
        const res2 = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'scan', 
                email: testEmail,
                _debug: true 
            })
        });
        
        if (!res2.ok) {
            debugLog(`✗ HTTP Error: ${res2.status} ${res2.statusText}`, 'error');
            const errorText = await res2.text();
            debugLog(`Respuesta: ${errorText.substring(0, 200)}`, 'error');
            return;
        }
        
        const data2 = await res2.json();
        if (data2.status === 'success') {
            debugLog(`✓ Scan exitoso: ${data2.tipo} - ${data2.nombre}`, 'success');
        } else {
            debugLog(`✗ Scan falló: ${data2.message}`, 'error');
        }
        
    } catch (error) {
        debugLog(`✗ Error de conexión: ${error.message}`, 'error');
        console.error('Error completo:', error);
    }
}

// ========== SCANNER FUNCTIONS ==========
function onScanSuccess(decodedText) {
    debugLog(`📷 QR escaneado: ${decodedText}`);
    
    // NO detener el escáner, solo pausar temporalmente
    if (html5QrCode) {
        // Pausar el escáner en lugar de detenerlo
        html5QrCode.pause();
        debugLog('⏸️ Escáner pausado temporalmente');
        
        procesarQR(decodedText.trim());
    } else {
        procesarQR(decodedText.trim());
    }
}

async function procesarQR(email) {
    debugLog(`📧 Procesando email: ${email}`);
    
    if (!email || !email.includes('@')) {
        debugLog('❌ Código QR inválido (no es email)', 'error');
        mostrarResultado("❌ Código inválido", "red");
        setTimeout(reiniciarEscaneo, 2000);
        return;
    }
    
    try {
        debugLog(`🔄 Enviando SCAN vía GET...`);
        
        // USAR GET en lugar de POST (para evitar CORS)
        const url = `${SCRIPT_URL}?action=scan&email=${encodeURIComponent(email)}&timestamp=${Date.now()}`;
        debugLog(`📤 URL: ${url}`);
        
        const res = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache'
        });
        
        debugLog(`📥 Response status: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const responseText = await res.text();
        debugLog(`📦 Response body: ${responseText.substring(0, 150)}...`);
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (jsonError) {
            debugLog(`❌ Error parseando JSON: ${jsonError.message}`, 'error');
            mostrarResultado("❌ Error en respuesta del servidor", "red");
            return;
        }
        
        if (data.status === 'success') {
            debugLog(`✅ Registro exitoso: ${data.tipo} - ${data.nombre}`, 'success');
            
            const icono = data.tipo === 'Entrada' ? '✅' : '🚪';
            const colorClass = data.tipo === 'Entrada' ? 'text-emerald-400' : 'text-orange-400';
            const bgClass = data.tipo === 'Entrada' ? 'bg-emerald-900/20' : 'bg-orange-900/20';
            
            mostrarResultado(
                `<div class="${bgClass} p-6 rounded-2xl border-2 ${colorClass.replace('text', 'border')}">
                    <div class="text-5xl mb-3">${icono}</div>
                    <div class="text-2xl font-bold ${colorClass} mb-1">${data.tipo.toUpperCase()}</div>
                    <div class="text-xl font-semibold text-white mb-2">${data.nombre}</div>
                    <div class="text-sm text-slate-300">${data.email}</div>
                    <div class="text-xs text-slate-400 mt-2">${data.hora} • ${data.fecha}</div>
                    <div class="text-xs text-slate-500 mt-3">${data.message}</div>
                </div>`,
                data.tipo === 'Entrada' ? 'emerald' : 'orange'
            );
            
            // Auto-reiniciar después de 3 segundos
            setTimeout(reiniciarEscaneo, 3000);
            
        } else {
            debugLog(`❌ Error API: ${data.message || "Desconocido"}`, 'error');
            mostrarResultado(
                `<div class="bg-red-900/20 p-6 rounded-2xl border-2 border-red-400">
                    <div class="text-4xl mb-3">❌</div>
                    <div class="text-xl font-bold text-red-400">ERROR</div>
                    <div class="text-white mt-2">${data.message || "No se pudo registrar"}</div>
                </div>`,
                "red"
            );
            setTimeout(reiniciarEscaneo, 3000);
        }
        
    } catch (err) {
        debugLog(`💥 Error de conexión: ${err.message}`, 'error');
        console.error('Error completo:', err);
        
        // Mensaje amigable según el tipo de error
        if (err.message.includes('Failed to fetch') || err.message.includes('CORS')) {
            mostrarResultado(
                `<div class="bg-yellow-900/20 p-6 rounded-2xl border-2 border-yellow-400">
                    <div class="text-4xl mb-3">🌐</div>
                    <div class="text-xl font-bold text-yellow-400">ERROR DE CONEXIÓN</div>
                    <div class="text-white mt-2">Problema de CORS con la API</div>
                    <div class="text-sm text-yellow-300 mt-3">Intenta escanear nuevamente</div>
                </div>`,
                "yellow"
            );
        } else {
            mostrarResultado(
                `<div class="bg-yellow-900/20 p-6 rounded-2xl border-2 border-yellow-400">
                    <div class="text-4xl mb-3">⚠️</div>
                    <div class="text-xl font-bold text-yellow-400">ERROR DE CONEXIÓN</div>
                    <div class="text-white mt-2">${err.message || "Error desconocido"}</div>
                    <div class="text-sm text-yellow-300 mt-3">Intenta nuevamente</div>
                </div>`,
                "yellow"
            );
        }
        
        setTimeout(reiniciarEscaneo, 3000);
    }
}

function mostrarResultado(mensaje, color) {
    const div = document.getElementById('mensaje');
    div.innerHTML = mensaje;
    div.className = `text-xl font-bold mb-4 text-${color}-400`;
    document.getElementById('resultado').classList.remove('hidden');
}

function reiniciarEscaneo() {
    debugLog('▶️ Reanudando escáner...');
    document.getElementById('resultado').classList.add('hidden');
    
    // Reanudar el escáner en lugar de reiniciarlo
    if (html5QrCode) {
        html5QrCode.resume().then(() => {
            debugLog('✅ Escáner reanudado');
        }).catch(err => {
            debugLog(`❌ Error reanudando: ${err}`, 'error');
            // Si falla al reanudar, reiniciar completamente
            iniciarEscaneo();
        });
    } else {
        iniciarEscaneo();
    }
}

function iniciarEscaneo() {
    debugLog('🚀 Iniciando escáner de cámara...');
    
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true
    };
    
    html5QrCode = new Html5Qrcode("reader");
    
    html5QrCode.start(
        { facingMode: "environment" }, 
        config, 
        onScanSuccess, 
        (errorMessage) => {
            // Este callback se llama continuamente cuando no hay QR
            // No logueamos para no spammear
        }
    ).then(() => {
        debugLog('✅ Escáner iniciado correctamente', 'success');
    }).catch(err => {
        debugLog(`❌ Error iniciando escáner: ${err.message || err}`, 'error');
        document.getElementById('reader').innerHTML = `
            <div class="p-8 bg-slate-800 text-red-400 rounded-2xl">
                <h3 class="text-xl font-bold mb-2">⚠️ Error de Cámara</h3>
                <p class="mb-4">${err.message || 'No se pudo acceder a la cámara.'}</p>
                <p class="text-sm text-slate-400">Posibles soluciones:</p>
                <ul class="text-sm text-slate-400 list-disc pl-5 mt-2">
                    <li>Permite el uso de la cámara en tu navegador</li>
                    <li>Asegúrate de que la cámara no esté siendo usada por otra aplicación</li>
                    <li>Prueba con otro navegador (Chrome/Edge)</li>
                    <li>Recarga la página</li>
                </ul>
                <button onclick="location.reload()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    🔄 Recargar Página
                </button>
            </div>
        `;
    });
}

// ========== INICIALIZACIÓN ==========
window.onload = () => {
    debugLog('🖥️ Página cargada');
    
    // Verificar sesión
    try {
        const s = localStorage.getItem('userSession');
        if (!s) {
            debugLog('❌ No hay sesión, redirigiendo a login...', 'error');
            alert("Debes iniciar sesión primero.");
            location.replace('login.html');
            return;
        }
        
        const user = JSON.parse(s);
        debugLog(`👤 Usuario: ${user.nombre} (${user.rol})`, 'success');
        
        // Permitir más roles (no solo Director)
        const rolesAutorizados = ['Director', 'Docente', 'Admin', 'Personal', 'Monitor'];
        if (!rolesAutorizados.includes(user.rol)) {
            debugLog(`❌ Rol no autorizado: ${user.rol}`, 'error');
            alert(`Acceso denegado. Solo personal autorizado puede usar el escáner.\nTu rol: ${user.rol}`);
            location.replace('index.html');
            return;
        }
        
        // Test de conexión automático
        setTimeout(testConnection, 1000);
        
        // Iniciar escáner
        iniciarEscaneo();
        
    } catch (error) {
        debugLog(`💥 Error cargando sesión: ${error.message}`, 'error');
        localStorage.removeItem('userSession');
        location.replace('login.html');
    }
};

// ========== FUNCIONES EXTRAS ==========
// Para probar manualmente desde consola
window.debugScan = function(email = 'ramonv@gmail.com') {
    debugLog(`🔍 Debug scan manual: ${email}`);
    procesarQR(email);
};

window.showSession = function() {
    const session = localStorage.getItem('userSession');
    console.log('Session:', session ? JSON.parse(session) : 'No hay sesión');
    return session ? JSON.parse(session) : null;
};
</script>
</body>
</html>
