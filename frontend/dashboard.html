<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - QR Gate Skool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>
                            Dashboard de Accesos
                        </h1>
                        <p class="text-sm text-gray-600">Estadísticas y reportes en tiempo real</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="font-semibold text-gray-800" id="dashboardUser">Cargando...</div>
                        <div class="text-sm text-gray-500" id="dashboardRole"></div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Escaneos Hoy</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="totalScans">248</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-qrcode text-blue-500 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                        <span class="text-green-500 font-medium">+12%</span>
                        <span class="text-gray-500 ml-2">vs ayer</span>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Entradas</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="totalEntries">156</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-sign-in-alt text-green-500 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                        <span class="text-green-500 font-medium">+8%</span>
                        <span class="text-gray-500 ml-2">vs ayer</span>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-orange-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Salidas</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="totalExits">92</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-sign-out-alt text-orange-500 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-arrow-down text-red-500 mr-1"></i>
                        <span class="text-red-500 font-medium">-3%</span>
                        <span class="text-gray-500 ml-2">vs ayer</span>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Usuarios Únicos</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="uniqueUsers">87</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-users text-purple-500 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                        <span class="text-green-500 font-medium">+5%</span>
                        <span class="text-gray-500 ml-2">vs ayer</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Chart 1: Daily Activity -->
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                    Actividad Diaria (Últimos 7 días)
                </h3>
                <div class="chart-container p-4 rounded-lg">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Entry vs Exit -->
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-pie text-green-500 mr-2"></i>
                    Distribución Entradas vs Salidas
                </h3>
                <div class="chart-container p-4 rounded-lg">
                    <canvas id="entryExitChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow mb-8">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-history text-purple-500 mr-2"></i>
                    Actividad Reciente
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recentActivity">
                        <!-- Las filas se llenarán con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Time Filters -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-filter text-orange-500 mr-2"></i>
                    Filtros de Tiempo
                </h3>
                <div class="flex flex-wrap gap-3">
                    <button onclick="filterData('today')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                        Hoy
                    </button>
                    <button onclick="filterData('week')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                        Esta Semana
                    </button>
                    <button onclick="filterData('month')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                        Este Mes
                    </button>
                    <button onclick="filterData('year')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                        Este Año
                    </button>
                    <div class="ml-auto">
                        <button onclick="refreshData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-download text-purple-500 mr-2"></i>
                Exportar Datos
            </h3>
            <div class="flex flex-wrap gap-4">
                <button onclick="exportData('csv')" class="bg-gray-800 hover:bg-gray-900 text-white px-5 py-3 rounded-lg transition flex items-center">
                    <i class="fas fa-file-csv mr-2"></i> CSV
                </button>
                <button onclick="exportData('pdf')" class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-lg transition flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i> PDF
                </button>
                <button onclick="exportData('excel')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg transition flex items-center">
                    <i class="fas fa-file-excel mr-2"></i> Excel
                </button>
                <button onclick="printReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition flex items-center">
                    <i class="fas fa-print mr-2"></i> Imprimir Reporte
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-gray-600 text-sm">
                <p>© 2024 QR Gate Skool - Sistema de Dashboard</p>
                <p class="mt-1">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Datos protegidos | 
                    <i class="fas fa-clock ml-3 mr-1"></i>
                    Actualizado: <span id="lastUpdate">Cargando...</span>
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Variables globales
        let dailyChart, entryExitChart;
        let currentFilter = 'today';

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar sesión
            const session = localStorage.getItem('userSession');
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const user = JSON.parse(session);
                document.getElementById('dashboardUser').textContent = user.nombre;
                document.getElementById('dashboardRole').textContent = user.rol;
                
                // Solo admin y director pueden ver dashboard
                if (!['Director', 'Admin', 'Supervisor'].includes(user.rol)) {
                    alert('Acceso denegado. Solo personal autorizado puede ver el dashboard.');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Cargar datos
                loadDashboardData();
                initializeCharts();
                updateLastUpdateTime();
                
                // Actualizar datos cada 30 segundos
                setInterval(loadDashboardData, 30000);
                
            } catch (error) {
                console.error('Error cargando sesión:', error);
                localStorage.removeItem('userSession');
                window.location.href = 'login.html';
            }
        });

        function loadDashboardData() {
            // Simular datos (en producción vendría de una API)
            generateSampleData();
            updateRecentActivity();
        }

        function generateSampleData() {
            // Actualizar estadísticas con datos aleatorios
            document.getElementById('totalScans').textContent = Math.floor(Math.random() * 100) + 200;
            document.getElementById('totalEntries').textContent = Math.floor(Math.random() * 80) + 120;
            document.getElementById('totalExits').textContent = Math.floor(Math.random() * 60) + 80;
            document.getElementById('uniqueUsers').textContent = Math.floor(Math.random() * 30) + 60;
            
            // Actualizar gráficos
            updateCharts();
        }

        function initializeCharts() {
            const ctx1 = document.getElementById('dailyChart').getContext('2d');
            const ctx2 = document.getElementById('entryExitChart').getContext('2d');
            
            // Gráfico de actividad diaria
            dailyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Escaneos',
                        data: [65, 59, 80, 81, 56, 55, 40],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Gráfico de entrada vs salida
            entryExitChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Entradas', 'Salidas'],
                    datasets: [{
                        data: [65, 35],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(249, 115, 22, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(249, 115, 22, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Generar datos aleatorios para los gráficos
            const newDailyData = Array.from({length: 7}, () => Math.floor(Math.random() * 100) + 20);
            const entryPercent = Math.floor(Math.random() * 30) + 60;
            const exitPercent = 100 - entryPercent;
            
            // Actualizar gráfico de línea
            dailyChart.data.datasets[0].data = newDailyData;
            dailyChart.update();
            
            // Actualizar gráfico de dona
            entryExitChart.data.datasets[0].data = [entryPercent, exitPercent];
            entryExitChart.update();
        }

        function updateRecentActivity() {
            const activities = [
                {name: 'María García', email: 'maria@escuela.edu', type: 'Entrada', time: '08:45', status: 'success'},
                {name: 'Carlos Rodríguez', email: 'carlos@escuela.edu', type: 'Salida', time: '09:15', status: 'success'},
                {name: 'Ana Martínez', email: 'ana@escuela.edu', type: 'Entrada', time: '09:30', status: 'success'},
                {name: 'José López', email: 'jose@escuela.edu', type: 'Entrada', time: '10:05', status: 'success'},
                {name: 'Laura Fernández', email: 'laura@escuela.edu', type: 'Salida', time: '10:45', status: 'warning'},
                {name: 'Miguel Sánchez', email: 'miguel@escuela.edu', type: 'Entrada', time: '11:20', status: 'success'},
                {name: 'Isabel Pérez', email: 'isabel@escuela.edu', type: 'Entrada', time: '11:45', status: 'success'},
                {name: 'Francisco Gómez', email: 'francisco@escuela.edu', type: 'Salida', time: '12:15', status: 'success'}
            ];
            
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = '';
            
            activities.forEach(activity => {
                const statusClass = activity.status === 'success' ? 'bg-green-100 text-green-800' : 
                                   activity.status === 'warning' ? 'bg-yellow-100 text-yellow-800' : 
                                   'bg-red-100 text-red-800';
                const statusText = activity.status === 'success' ? 'Correcto' : 
                                  activity.status === 'warning' ? 'Advertencia' : 'Error';
                const typeIcon = activity.type === 'Entrada' ? '⬆️' : '⬇️';
                
                const row = `
                    <tr>
                        <td class="py-3 px-6 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-blue-600 font-medium">${activity.name.charAt(0)}</span>
                                </div>
                                <div class="ml-3">
                                    <div class="font-medium text-gray-900">${activity.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-6 whitespace-nowrap">
                            <div class="text-gray-900">${activity.email}</div>
                        </td>
                        <td class="py-3 px-6 whitespace-nowrap">
                            <span class="font-medium ${activity.type === 'Entrada' ? 'text-green-600' : 'text-orange-600'}">
                                ${typeIcon} ${activity.type}
                            </span>
                        </td>
                        <td class="py-3 px-6 whitespace-nowrap text-gray-900">${activity.time}</td>
                        <td class="py-3 px-6 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
                
                tbody.innerHTML += row;
            });
        }

        function filterData(filter) {
            currentFilter = filter;
            
            // Actualizar UI de botones
            document.querySelectorAll('[onclick^="filterData"]').forEach(btn => {
                if (btn.textContent.includes(filter.charAt(0).toUpperCase() + filter.slice(1))) {
                    btn.classList.remove('bg-gray-200', 'text-gray-800');
                    btn.classList.add('bg-blue